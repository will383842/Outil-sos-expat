// üöÄ Point d'entr√©e ultra-moderne 2025 pour outil interne ChatGPT
// Plateforme d'assistance IA pour √©quipe de support

import { StrictMode } from 'react';
import { createRoot } from 'react-dom/client';
import App from './App.tsx';
import './index.css';

// üîß Configuration environnement pour outil interne
const isDevelopment = import.meta.env.DEV;
const isProduction = import.meta.env.PROD;
const appVersion = import.meta.env.VITE_APP_VERSION || '1.0.0';
const apiUrl = import.meta.env.VITE_API_URL || 'https://api.company.fr';

// üìä Monitoring et analytics pour usage interne
if (isProduction) {
  // Configuration analytics interne (Google Analytics, Mixpanel, etc.)
  console.log('üöÄ IA Platform d√©marr√©e en production');
  console.log('üìä Version:', appVersion);
  
  // Tracking des erreurs en production (Sentry, LogRocket, etc.)
  window.addEventListener('error', (event) => {
    console.error('üí• Erreur application:', event.error);
    // Ici on enverrait l'erreur √† un service de monitoring
    // sentry.captureException(event.error);
  });

  // Tracking des performances pour optimisation √©quipe
  window.addEventListener('load', () => {
    const loadTime = performance.now();
    console.log('‚ö° Temps de chargement:', Math.round(loadTime), 'ms');
    
    // M√©triques Web Vitals pour l'√©quipe tech
    // getCLS, getFID, getFCP, getLCP, getTTFB
  });
}

// üîß Configuration d√©veloppement pour √©quipe
if (isDevelopment) {
  console.log('üõ†Ô∏è IA Platform en mode d√©veloppement');
  console.log('üîó API URL:', apiUrl);
  console.log('üéØ Version:', appVersion);
  
  // Hot Module Replacement info
  if (import.meta.hot) {
    console.log('üî• Hot reload activ√©');
  }
  
  // Outils d√©veloppement React (React DevTools)
  if (typeof window !== 'undefined') {
    if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__ && window.__REACT_DEVTOOLS_GLOBAL_HOOK__.onCommitFiberRoot) {
      window.__REACT_DEVTOOLS_GLOBAL_HOOK__.onCommitFiberRoot = (id, root) => {
        // Logging pour debugging √©quipe
      };
    }
  }
}

// üö® Error Boundary global pour stabilit√© production
class GlobalErrorBoundary extends Error {
  constructor(message: string, public originalError?: Error) {
    super(message);
    this.name = 'GlobalErrorBoundary';
  }
}

// üì± D√©tection PWA et installation pour √©quipe mobile
if ('serviceWorker' in navigator && isProduction) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('/sw.js')
      .then((registration) => {
        console.log('üì± Service Worker enregistr√©:', registration.scope);
        
        // Notification √©quipe pour mise √† jour disponible
        registration.addEventListener('updatefound', () => {
          console.log('üîÑ Nouvelle version disponible');
          // Notification toast pour l'√©quipe
        });
      })
      .catch((error) => {
        console.error('‚ùå Erreur Service Worker:', error);
      });
  });

  // Prompt d'installation PWA pour √©quipe
  window.addEventListener('beforeinstallprompt', (e) => {
    console.log('üì≤ Installation PWA disponible');
    // Stocker l'√©v√©nement pour installation ult√©rieure
    (window as any).deferredPrompt = e;
  });
}

// üåê Configuration internationalisation (i18n) pour √©quipe
const supportedLanguages = ['fr', 'en'] as const;
const defaultLanguage = 'fr';
const userLanguage = navigator.language.split('-')[0] as typeof supportedLanguages[number];
const appLanguage = supportedLanguages.includes(userLanguage) ? userLanguage : defaultLanguage;

// Stockage pr√©f√©rence langue √©quipe
localStorage.setItem('app-language', appLanguage);
console.log('üåç Langue d√©tect√©e:', appLanguage);

// üé® Gestion du th√®me pour interface √©quipe
const detectTheme = (): 'light' | 'dark' | 'auto' => {
  const savedTheme = localStorage.getItem('app-theme') as 'light' | 'dark' | 'auto';
  if (savedTheme) return savedTheme;
  
  // Pr√©f√©rence syst√®me par d√©faut
  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
};

const applyTheme = (theme: 'light' | 'dark' | 'auto') => {
  const root = document.documentElement;
  
  if (theme === 'auto') {
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    root.setAttribute('data-theme', systemDark ? 'dark' : 'light');
  } else {
    root.setAttribute('data-theme', theme);
  }
  
  localStorage.setItem('app-theme', theme);
};

// Initialiser le th√®me
applyTheme(detectTheme());

// √âcouter les changements de pr√©f√©rence syst√®me
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
  const currentTheme = localStorage.getItem('app-theme');
  if (currentTheme === 'auto' || !currentTheme) {
    applyTheme('auto');
  }
});

// üîã Monitoring des performances pour optimisation √©quipe
const startPerformanceMonitoring = () => {
  // Memory usage pour d√©bogage
  if ('memory' in performance) {
    const memory = (performance as any).memory;
    console.log('üíæ M√©moire utilis√©e:', Math.round(memory.usedJSHeapSize / 1024 / 1024), 'MB');
  }
  
  // Network status pour √©quipe mobile
  if ('connection' in navigator) {
    const connection = (navigator as any).connection;
    console.log('üì∂ Connexion:', connection.effectiveType, '- D√©bit:', connection.downlink, 'Mbps');
  }
  
  // Battery status pour √©quipe mobile
  if ('getBattery' in navigator) {
    (navigator as any).getBattery().then((battery: any) => {
      console.log('üîã Batterie:', Math.round(battery.level * 100) + '%');
    });
  }
};

if (isDevelopment) {
  startPerformanceMonitoring();
}

// üöÄ Configuration globale pour l'√©quipe
window.__APP_CONFIG__ = {
  version: appVersion,
  environment: isDevelopment ? 'development' : 'production',
  apiUrl,
  language: appLanguage,
  theme: detectTheme(),
  features: {
    analytics: isProduction,
    devTools: isDevelopment,
    pwa: 'serviceWorker' in navigator,
    notifications: 'Notification' in window,
    offline: 'serviceWorker' in navigator,
    realtime: 'WebSocket' in window
  }
};

// üìä M√©triques de d√©marrage pour √©quipe tech
const appStartTime = performance.now();
console.log('üèÅ Initialisation app:', Math.round(appStartTime), 'ms');

// üéØ Initialisation des fonctionnalit√©s internes
const initializeInternalFeatures = () => {
  // Raccourcis clavier pour √©quipe
  document.addEventListener('keydown', (e) => {
    // Ctrl+K ou Cmd+K : Recherche rapide
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      console.log('üîç Recherche rapide activ√©e');
      // Ouvrir modal de recherche
    }
    
    // Ctrl+/ ou Cmd+/ : Raccourcis aide
    if ((e.ctrlKey || e.metaKey) && e.key === '/') {
      e.preventDefault();
      console.log('‚ùì Aide raccourcis activ√©e');
      // Afficher aide raccourcis
    }
    
    // Escape : Fermer modals
    if (e.key === 'Escape') {
      console.log('üö™ Fermeture modals');
      // Fermer toutes les modals ouvertes
    }
  });

  // Notifications permission pour √©quipe
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission().then((permission) => {
      console.log('üîî Notifications:', permission);
    });
  }

  // Gestion hors ligne pour √©quipe mobile
  window.addEventListener('online', () => {
    console.log('üåê Connexion r√©tablie');
    // Synchroniser donn√©es en attente
  });

  window.addEventListener('offline', () => {
    console.log('üìµ Mode hors ligne');
    // Informer √©quipe du mode offline
  });
};

// üé≠ Splash screen et loading pour UX √©quipe
const showSplashScreen = () => {
  const splash = document.createElement('div');
  splash.id = 'app-splash';
  splash.innerHTML = `
    <div style="
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #ddd6fe 50%, #e0e7ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-family: Inter, sans-serif;
    ">
      <div style="text-align: center;">
        <div style="
          width: 80px;
          height: 80px;
          background: linear-gradient(135deg, #6366f1, #8b5cf6);
          border-radius: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 0 auto 24px;
          animation: pulse 2s infinite;
        ">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
            <path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14l-2-4H7l-2 4z"/>
          </svg>
        </div>
        <h1 style="
          font-size: 24px;
          font-weight: 800;
          background: linear-gradient(135deg, #1e293b, #6366f1, #8b5cf6);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          margin: 0 0 12px;
        ">IA Platform</h1>
        <p style="color: #64748b; margin: 0; font-weight: 500;">
          Chargement de l'outil interne...
        </p>
      </div>
    </div>
    <style>
      @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }
    </style>
  `;
  
  document.body.appendChild(splash);
  
  // Supprimer splash apr√®s chargement
  setTimeout(() => {
    splash.remove();
  }, 1500);
};

// üöÄ Rendu de l'application
const renderApp = () => {
  const rootElement = document.getElementById('root');
  
  if (!rootElement) {
    console.error('‚ùå √âl√©ment root introuvable');
    return;
  }

  // Splash screen pendant chargement
  if (isProduction) {
    showSplashScreen();
  }

  // Cr√©ation du root React 18
  const root = createRoot(rootElement);

  // Configuration React StrictMode pour d√©tection probl√®mes
  root.render(
    <StrictMode>
      <App />
    </StrictMode>
  );

  // Initialiser fonctionnalit√©s apr√®s rendu
  setTimeout(() => {
    initializeInternalFeatures();
    
    const totalLoadTime = performance.now() - appStartTime;
    console.log('‚úÖ App totalement charg√©e en:', Math.round(totalLoadTime), 'ms');
    
    // M√©triques pour √©quipe tech
    if (isDevelopment) {
      console.log('üéØ Config app:', window.__APP_CONFIG__);
    }
  }, 100);
};

// üé¨ D√©marrage de l'application
renderApp();

// üîÑ Hot Module Replacement pour d√©veloppement
if (import.meta.hot) {
  import.meta.hot.accept('./App.tsx', () => {
    console.log('üî• Hot reload: App.tsx mis √† jour');
  });
}

// üåç Export des utilitaires globaux pour √©quipe
declare global {
  interface Window {
    __APP_CONFIG__: {
      version: string;
      environment: 'development' | 'production';
      apiUrl: string;
      language: string;
      theme: string;
      features: {
        analytics: boolean;
        devTools: boolean;
        pwa: boolean;
        notifications: boolean;
        offline: boolean;
        realtime: boolean;
      };
    };
    deferredPrompt?: any;
  }
}