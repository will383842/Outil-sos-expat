rules_version = '2';

// ==========================================
// FIRESTORE DATABASE RULES - SOS-EXPAT
// ==========================================
service cloud.firestore {
  match /databases/{database}/documents {

    // ================= HELPER FUNCTIONS =================
    function isAuthenticated() {
      return request.auth != null;
    }

    // Vérifie si l'utilisateur est admin via:
    // 1. Custom claims Firebase Auth (request.auth.token.role)
    // 2. OU le document Firestore users/{uid}.role
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.role == 'admin' ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    // SECURITE: Le role 'dev' est DESACTIVE en production
    // Pour activer temporairement en dev, definir une variable d'environnement
    // Cette fonction retourne TOUJOURS false en production
    function isDev() {
      // PRODUCTION: Toujours false - aucun acces dev en production
      return false;
      // Pour debug local uniquement, decommenter la ligne suivante:
      // return request.auth != null && request.auth.token.role == 'dev';
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isProvider() {
      return request.auth != null &&
             (request.auth.token.role == 'lawyer' || request.auth.token.role == 'expat');
    }

    function isClient() {
      return request.auth != null && request.auth.token.role == 'client';
    }

    // Finance admin: admin avec acces aux donnees financieres
    function isFinanceAdmin() {
      return isAdmin();
    }

    // Super admin: admin avec tous les droits
    function isSuperAdmin() {
      return isAdmin();
    }

    // ================= USERS COLLECTION =================
    // P0 SECURITY FIX: Protection des champs de privilèges contre l'escalade
    match /users/{userId} {
      allow read: if isAuthenticated();
      // Création : propriétaire OU admin/dev (pour les profils AAA)
      allow create: if (isAuthenticated() && isOwner(userId) &&
                    // Empêcher la création avec des rôles admin/dev par les utilisateurs normaux
                    (!request.resource.data.keys().hasAny(['role']) ||
                     request.resource.data.role in ['client', 'lawyer', 'expat']))
                    || isAdmin() || isDev();
      // L'utilisateur peut modifier ses propres données SAUF:
      // - role, isApproved, approvalStatus: empêche l'escalade de privilèges
      // - isBanned, bannedAt, bannedReason: empêche la désactivation du ban
      // - forcedAiAccess, freeTrialUntil: empêche l'accès gratuit non autorisé
      // - stripeCustomerId: protège l'intégrité financière
      // - payoutMode, aaaPayoutMode, isAAA: protège le routage des paiements (admin-only)
      allow update: if (isOwner(userId) &&
                        !request.resource.data.diff(resource.data).affectedKeys()
                          .hasAny(['role', 'isApproved', 'approvalStatus', 'isBanned',
                                   'bannedAt', 'bannedReason', 'forcedAiAccess',
                                   'forceAiAccess', 'forcedAIAccess', 'freeTrialUntil',
                                   'freeTrialGrantedBy', 'stripeCustomerId',
                                   'payoutMode', 'aaaPayoutMode', 'isAAA']))
                       || isAdmin() || isDev();
      allow delete: if isAdmin() || isDev();
    }

    // ================= SOS_PROFILES COLLECTION =================
    // P0 SECURITY: Les IDs Stripe/PayPal ne doivent JAMAIS être exposés côté client
    // Ces champs sont gérés uniquement par Cloud Functions via Admin SDK
    match /sos_profiles/{profileId} {
      // P0 SECURITY: Les IDs Stripe/PayPal ne doivent JAMAIS être exposés côté client
      // Ces champs sont gérés uniquement par Cloud Functions via Admin SDK
      // NOTE: stripeAccountId, paypalMerchantId ne sont pas inclus dans les projections frontend
      // P1-6 SECURITY FIX: Restreindre la lecture aux profils visibles ou au propriétaire
      // Empêche l'énumération de tous les providers et protège les données sensibles
      allow read: if resource.data.isVisible == true
                  || (isAuthenticated() && request.auth.uid == profileId)
                  || isAdmin() || isDev();

      // Écriture : propriétaire ou admin
      // NOTE: On ne peut pas utiliser isProvider() ici car les custom claims
      // ne sont définis qu'APRÈS la création du profil (via onProviderCreated trigger)
      // Le propriétaire NE PEUT PAS modifier les champs financiers sensibles
      // Admin/Dev peuvent créer des profils AAA (profils gérés en interne)
      allow create: if (isAuthenticated() && isOwner(profileId) &&
                    !request.resource.data.keys().hasAny(['stripeAccountId', 'paypalMerchantId', 'stripeCustomerId']))
                    || isAdmin() || isDev();
      // P0-1 SECURITY FIX: paypalEmailVerified et paypalEmailVerifiedAt sont protégés
      // pour empêcher un provider de se marquer comme vérifié sans validation email
      // P0 SECURITY: payoutMode, aaaPayoutMode et isAAA sont protégés (admin-only)
      // pour empêcher un provider de rediriger ses paiements
      allow update: if (isOwner(profileId) &&
                        !request.resource.data.diff(resource.data).affectedKeys()
                          .hasAny(['stripeAccountId', 'paypalMerchantId', 'stripeCustomerId',
                                   'totalEarnings', 'totalPayPalEarnings', 'pendingBalance', 'reservedBalance',
                                   'paypalEmailVerified', 'paypalEmailVerifiedAt',
                                   'payoutMode', 'aaaPayoutMode', 'isAAA']))
                       || isAdmin() || isDev();
      allow delete: if isAdmin() || isDev();

      // Sous-collection reviews
      match /reviews/{reviewId} {
        allow read: if true;
        allow create: if isAuthenticated();
        allow update, delete: if isAdmin() || isDev();
      }
    }

    // ================= REVIEWS COLLECTION =================
    match /reviews/{reviewId} {
      // Lecture : tout le monde pour les avis publiés, admin/dev pour tous
      allow read: if resource.data.status == 'published' && resource.data.isPublic == true
                  || isAdmin()
                  || isDev()
                  || (isAuthenticated() && resource.data.clientId == request.auth.uid)
                  || (isAuthenticated() && resource.data.providerId == request.auth.uid);

      // Création : client authentifié uniquement
      // Validation : le clientId doit correspondre à l'utilisateur connecté
      allow create: if isAuthenticated()
                    && request.resource.data.clientId == request.auth.uid
                    && request.resource.data.providerId is string
                    && request.resource.data.callId is string
                    && request.resource.data.rating is number
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5
                    && request.resource.data.comment is string
                    && request.resource.data.comment.size() > 0
                    && request.resource.data.comment.size() <= 2000;

      // Mise à jour :
      // - Le prestataire peut modifier isPublic et status (pour show/hide)
      // - Admin peut tout modifier
      allow update: if isAdmin()
                    || isDev()
                    || (isAuthenticated()
                        && resource.data.providerId == request.auth.uid
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isPublic', 'status']));

      // Suppression : admin seulement
      allow delete: if isAdmin() || isDev();
    }

    // ================= CALLS/CALL_SESSIONS COLLECTION =================
    match /calls/{callId} {
      allow read: if isAuthenticated() &&
                  (resource.data.clientId == request.auth.uid ||
                   resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // P1 SECURITY FIX: Validate clientId matches authenticated user
      allow create: if isAuthenticated() &&
                    request.resource.data.clientId == request.auth.uid;
      allow update: if isAuthenticated() &&
                    (resource.data.clientId == request.auth.uid ||
                     resource.data.providerId == request.auth.uid ||
                     isAdmin() || isDev());
      allow delete: if isAdmin() || isDev();
    }

    match /call_sessions/{sessionId} {
      // FIX: clientId et providerId sont dans metadata, pas au niveau racine
      // Pour les requêtes avec where(), on vérifie que l'utilisateur demande ses propres sessions
      // NOTE: Les requêtes DOIVENT filtrer par metadata.clientId ou metadata.providerId
      // P0 FIX: Support linkedProviderIds pour accès multi-provider (AiAssistantPageV2)
      allow read: if isAuthenticated() &&
                  (resource.data.metadata.clientId == request.auth.uid ||
                   resource.data.metadata.providerId == request.auth.uid ||
                   // Permettre les requêtes sur clientId au niveau racine (si présent)
                   (resource.data.clientId != null && resource.data.clientId == request.auth.uid) ||
                   (resource.data.providerId != null && resource.data.providerId == request.auth.uid) ||
                   // P0 FIX: Support linkedProviderIds - permet aux utilisateurs liés de lire les sessions
                   (resource.data.providerId != null &&
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.linkedProviderIds.hasAny([resource.data.providerId])) ||
                   (resource.data.metadata.providerId != null &&
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.linkedProviderIds.hasAny([resource.data.metadata.providerId])) ||
                   isAdmin() || isDev());
      // Seul le client peut créer une session (validation de l'ownership)
      allow create: if isAuthenticated() &&
                    (request.resource.data.metadata.clientId == request.auth.uid ||
                     request.resource.data.clientId == request.auth.uid);
      // Seuls les participants (client ou provider) peuvent mettre à jour
      allow update: if isAuthenticated() &&
                    (resource.data.metadata.clientId == request.auth.uid ||
                     resource.data.metadata.providerId == request.auth.uid ||
                     resource.data.clientId == request.auth.uid ||
                     resource.data.providerId == request.auth.uid ||
                     // P0 FIX: Support linkedProviderIds pour mise à jour
                     (resource.data.providerId != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.linkedProviderIds.hasAny([resource.data.providerId])) ||
                     isAdmin() || isDev());
      allow delete: if isAdmin() || isDev();
    }

    // ================= CALL EXECUTION LOCKS =================
    // P0 IDEMPOTENCE: Locks pour empêcher les exécutions multiples de Cloud Tasks
    // Gérés uniquement par Cloud Functions (Admin SDK)
    match /call_execution_locks/{lockId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions uniquement via Admin SDK
    }

    // ================= PAYMENTS COLLECTION =================
    // P0-7 SECURITY FIX: Les paiements ne peuvent être créés que par Cloud Functions
    // La création côté client permettrait:
    // - Création de faux paiements
    // - Manipulation des montants
    // - Bypass de la validation Stripe/PayPal
    match /payments/{paymentId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid ||
                   resource.data.clientId == request.auth.uid ||
                   resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // P0-7 FIX: SEULES les Cloud Functions (Admin SDK) peuvent créer des paiements
      // Anciennement: allow create avec validation côté client (VULNÉRABLE)
      // Les paiements doivent passer par createPaymentIntent/PayPal qui valident:
      // - Rate limiting, doublons, cohérence montants, validation métier
      allow create: if false;
      // Seules les Cloud Functions peuvent mettre à jour (via Admin SDK)
      allow update: if false;
      allow delete: if isAdmin() || isDev();
    }

    // ================= REFUNDS COLLECTION =================
    match /refunds/{refundId} {
      // Client et provider peuvent voir leurs remboursements
      allow read: if isAuthenticated() &&
                  (resource.data.clientId == request.auth.uid ||
                   resource.data.providerId == request.auth.uid ||
                   resource.data.userId == request.auth.uid ||
                   isAdmin() || isDev());
      // Seules les Cloud Functions peuvent écrire (via Admin SDK)
      allow write: if false;
    }

    // ================= JOURNAL_ENTRIES COLLECTION (Accounting) =================
    // Ecritures comptables generees automatiquement par les Cloud Functions
    match /journal_entries/{entryId} {
      // Lecture: admin uniquement (donnees comptables sensibles)
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement (via Admin SDK)
      // Les ecritures sont generees automatiquement par les triggers
      allow write: if false;
    }

    // ================= ACCOUNTING_SEQUENCES COLLECTION =================
    // Sequences de numerotation des ecritures comptables
    match /accounting_sequences/{seqId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // ================= ACCOUNTING_PERIODS COLLECTION =================
    // Periodes comptables (clotures, reporting)
    match /accounting_periods/{periodId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // ================= ORDERS COLLECTION =================
    match /orders/{orderId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid ||
                   resource.data.clientId == request.auth.uid ||
                   isAdmin() || isDev());
      // P1 SECURITY FIX: Validate userId/clientId matches authenticated user
      allow create: if isAuthenticated() &&
                    (request.resource.data.userId == request.auth.uid ||
                     request.resource.data.clientId == request.auth.uid);
      allow update: if isAdmin() || isDev();
      allow delete: if isAdmin() || isDev();
    }

    // ================= NOTIFICATIONS COLLECTION =================
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isAdmin() || isDev());
      // P1-6 SECURITY FIX: Valider que userId correspond à l'utilisateur authentifié
      // Empêche la création de notifications pour d'autres utilisateurs
      allow create: if (isAuthenticated() && request.resource.data.userId == request.auth.uid)
                    || isAdmin();
      allow update: if isOwner(resource.data.userId) || isAdmin() || isDev();
      allow delete: if isAdmin() || isDev();
    }

    // ================= FCM TOKENS COLLECTION (P1 Security Fix) =================
    match /fcm_tokens/{userId} {
      // Only token owner can read their own token
      allow read: if isOwner(userId) || isAdmin() || isDev();
      // Only token owner can create/update their token
      allow create, update: if isOwner(userId);
      // Owner or admin can delete
      allow delete: if isOwner(userId) || isAdmin() || isDev();
    }

    // ================= IN-APP NOTIFICATIONS (P2 Security Fix) =================
    match /inapp_notifications/{notificationId} {
      allow read: if isAuthenticated() &&
                  (resource.data.uid == request.auth.uid || isAdmin() || isDev());
      allow create: if false; // Only Cloud Functions can create
      allow update: if isAuthenticated() && resource.data.uid == request.auth.uid &&
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read', 'readAt']);
      allow delete: if isAdmin() || isDev();
    }

    // ================= MESSAGE EVENTS (Cloud Functions only) =================
    match /message_events/{eventId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Only Cloud Functions
    }

    // ================= MESSAGE DELIVERIES (Cloud Functions only) =================
    match /message_deliveries/{deliveryId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Only Cloud Functions
    }

    // ================= NOTIFICATION LOGS (Cloud Functions only) =================
    match /notification_logs/{logId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Only Cloud Functions
    }

    // ================= FAVORITES COLLECTION =================
    match /favorites/{favoriteId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isAdmin() || isDev());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isOwner(resource.data.userId) || isAdmin() || isDev();
    }

    // ================= FAQ COLLECTION =================
    match /faqs/{faqId} {
      allow read: if resource.data.isActive == true || isAdmin() || isDev();
      allow create, update, delete: if isAdmin() || isDev();
    }

    // ================= HELP CENTER COLLECTION =================
    match /helpCenter/{articleId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isDev();
    }

    // ================= HELP CATEGORIES COLLECTION =================
    match /help_categories/{categoryId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isDev();
    }

    // ================= HELP ARTICLES COLLECTION (for SEO sitemaps) =================
    match /help_articles/{articleId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isDev();
    }

    // ================= LANDING PAGES COLLECTION (for SEO sitemaps) =================
    match /landing_pages/{pageId} {
      allow read: if true;
      allow create, update, delete: if isAdmin() || isDev();
    }

    // ================= AAA USED CONTENT COLLECTION =================
    // Tracks which bio/review content has been used for AAA profile generation
    match /aaa_used_content/{documentId} {
      allow read: if isAdmin() || isDev();
      allow create: if isAdmin() &&
                   request.resource.data.keys().hasAll(['type', 'langCode', 'usedAt']) &&
                   request.resource.data.type in ['bio', 'review'];
      allow update, delete: if isAdmin() || isDev();
    }

    // ================= AAA_PROFILES COLLECTION =================
    match /aaa_profiles/{profileId} {
      allow read: if isAdmin() || isDev();
      allow write: if isAdmin() || isDev();
    }

    // ================= UI_PROFILE_CARDS COLLECTION =================
    // Cards de profil pour l'affichage UI (carrousel, grille, etc.)
    match /ui_profile_cards/{profileId} {
      allow read: if true;
      allow create, update: if isOwner(profileId) || isAdmin() || isDev();
      allow delete: if isAdmin() || isDev();
    }

    // ================= UI_PROFILE_CAROUSEL COLLECTION =================
    // Données pour le carrousel de profils
    match /ui_profile_carousel/{profileId} {
      allow read: if true;
      allow create, update: if isOwner(profileId) || isAdmin() || isDev();
      allow delete: if isAdmin() || isDev();
    }

    // ================= PROVIDER MESSAGE ORDER CUSTOMERS =================
    match /providerMessageOrderCustomers/{messageId} {
      allow create: if isAuthenticated()
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.providerId is string
        && request.resource.data.message is string
        && request.resource.data.message.size() > 0
        && request.resource.data.message.size() <= 1000;

      allow read: if (isAuthenticated()
        && (request.auth.uid == resource.data.providerId
            || request.auth.uid == resource.data.senderId))
        || isAdmin() || isDev();

      allow update: if isAuthenticated()
        && request.auth.uid == resource.data.providerId
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);

      allow delete: if isAdmin() || isDev();
    }

    // ================= PROVIDERS TRANSLATIONS =================
    match /providers_translations/{providerId} {
      allow read: if true;
      allow create: if (isAuthenticated() && request.auth.uid == providerId) || isAdmin() || isDev();
      allow update: if (isAuthenticated() && request.auth.uid == providerId) || isAdmin() || isDev();
      allow delete: if isAdmin() || isDev();
    }

    // ================= CONFIG COLLECTION =================
    match /config/{docId} {
      allow read: if isAdmin() || isDev();
      allow write: if isAdmin() || isDev();
    }

    // ================= ADMIN CONFIG COLLECTION =================
    // P0 FIX: Only pricing document is publicly readable (for public pricing pages)
    // Other admin_config documents (aaa_payout, etc.) require admin access
    match /admin_config/{docId} {
      allow read: if docId == 'pricing' || isAdmin() || isDev();
      allow write: if isAdmin() || isDev();
    }

    // ================= SETTINGS COLLECTION =================
    // P1 SECURITY FIX: Require authentication for settings read
    // Public settings should be moved to a dedicated 'public_config' collection
    match /settings/{docId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isDev();
    }

    // ================= DOCUMENTS COLLECTION =================
    match /documents/{documentId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid || isAdmin() || isDev());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin() || isDev();
      allow delete: if isAdmin() || isDev();
    }

    // ================= INVOICES COLLECTION =================
    // P0 FIX: Permet aux clients de créer leurs propres factures après paiement
    // La validation côté client assure que clientId == uid de l'utilisateur
    match /invoices/{invoiceId} {
      allow read: if isAuthenticated() &&
                  (resource.data.userId == request.auth.uid ||
                   resource.data.clientId == request.auth.uid ||
                   resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Le client peut créer une facture dont il est le client
      allow create: if isAuthenticated() &&
                    request.resource.data.clientId == request.auth.uid;
      // Seuls admins peuvent modifier/supprimer
      allow update, delete: if isAdmin() || isDev();
    }

    // ================= COUPONS COLLECTION =================
    // P1-7 SECURITY FIX: Bloquer lecture directe pour empêcher énumération/brute-force
    // Les coupons sont validés via Cloud Functions (validateCoupon) qui utilise Admin SDK
    // Note: Admin peut lire pour la console admin, mais les utilisateurs normaux ne peuvent pas
    match /coupons/{couponId} {
      allow read: if isAdmin() || isDev(); // Admin peut lire pour la console
      allow write: if isAdmin() || isDev();
    }

    // ================= AUDIT LOGS COLLECTION =================
    // P1 SECURITY FIX: Only Cloud Functions can create audit logs (via Admin SDK)
    // This prevents users from creating fake audit entries
    match /auditLogs/{logId} {
      allow read: if isAdmin() || isDev();
      allow create: if false; // Only Cloud Functions via Admin SDK
      allow update, delete: if false;
    }

    // ================= DISPUTES COLLECTION (Chargebacks) =================
    // P0 FIX: Permettre les mises à jour admin pour la gestion des litiges
    match /disputes/{disputeId} {
      // Only admins can read disputes (sensitive financial data)
      allow read: if isAdmin() || isDev();
      // P0 FIX: Admin peut mettre à jour (notes, timeline, status, evidence, assignee)
      // Pour les actions critiques (submit evidence to Stripe), utiliser Cloud Functions
      allow update: if (isAdmin() || isDev()) &&
                    request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['notes', 'timeline', 'updatedAt', 'isAcknowledged',
                               'internalNotes', 'adminAssignee', 'adminNotes',
                               'evidenceFiles', 'evidenceSubmittedAt', 'status',
                               'resolvedAt', 'resolvedBy', 'resolution']);
      // Create: Cloud Functions only (via Stripe webhooks)
      allow create: if false;
      // Delete: jamais (audit trail)
      allow delete: if false;
    }

    // ================= ADMIN ALERTS COLLECTION =================
    match /admin_alerts/{alertId} {
      allow read: if isAdmin() || isDev();
      // Admins can update (mark as read)
      allow update: if isAdmin() || isDev();
      // Only Cloud Functions can create
      allow create, delete: if false;
    }

    // ================= FINANCIAL EVENTS COLLECTION =================
    match /financial_events/{eventId} {
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PROVIDER BALANCE ADJUSTMENTS =================
    match /provider_balance_adjustments/{adjustmentId} {
      // Providers can read their own adjustments
      allow read: if isAuthenticated() &&
                  (resource.data.providerId == request.auth.uid || isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= KYC REMINDERS LOG =================
    match /kyc_reminders_log/{logId} {
      // Only admins can read reminder logs
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PAYPAL REMINDER QUEUE =================
    match /paypal_reminder_queue/{providerId} {
      // Providers can read their own reminder status
      allow read: if isAuthenticated() &&
                  (request.auth.uid == providerId || isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PAYPAL ACCOUNT LOGS =================
    match /paypal_account_logs/{logId} {
      // Providers can read their own logs, admins can read all
      allow read: if isAuthenticated() &&
                  (resource.data.providerId == request.auth.uid || isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= OUTIL IA SYNC RETRY QUEUE (P0-4 FIX) =================
    match /outil_sync_retry_queue/{bookingId} {
      // Only admins can read (for monitoring)
      allow read: if isAuthenticated() && isAdmin();
      // Only Cloud Functions can write (via Admin SDK)
      allow write: if false;
    }

    // ================= PAYPAL REMINDERS LOG =================
    match /paypal_reminders_log/{logId} {
      // Only admins can read reminder logs
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= UNCLAIMED FUNDS =================
    match /unclaimed_funds/{fundId} {
      // Only admins can read unclaimed funds
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= ADMIN ACTIONS LOG =================
    match /admin_actions_log/{logId} {
      // Only admins can read action logs
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PAYPAL ORDERS =================
    match /paypal_orders/{orderId} {
      // Clients can read their own orders, admins can read all
      allow read: if isAuthenticated() &&
                  (resource.data.clientId == request.auth.uid ||
                   resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PAYPAL REFERRALS (Merchant Onboarding) =================
    match /paypal_referrals/{referralId} {
      // Providers can read their own referrals, admins can read all
      allow read: if isAuthenticated() &&
                  (resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PAYPAL WEBHOOK EVENTS =================
    match /paypal_webhook_events/{eventId} {
      // Only admins can read webhook events
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PAYOUTS COLLECTION =================
    // Versements aux prestataires (Stripe + PayPal unifiés)
    match /payouts/{payoutId} {
      // Providers can read their own payouts, admins can read all
      allow read: if isAuthenticated() &&
                  (resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PAYPAL PAYOUTS =================
    match /paypal_payouts/{payoutId} {
      // Providers can read their own payouts, admins can read all
      allow read: if isAuthenticated() &&
                  (resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PAYPAL PAYOUTS FAILED =================
    match /paypal_payouts_failed/{failedId} {
      // Only admins can read failed payouts
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= STRIPE TRANSFERS =================
    match /transfers/{transferId} {
      // Providers can read their own transfers, admins can read all
      allow read: if isAuthenticated() &&
                  (resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= PENDING TRANSFERS (Deferred KYC) =================
    match /pending_transfers/{transferId} {
      // Providers can read their own pending transfers
      // This allows them to see how much is pending until they complete KYC
      allow read: if isAuthenticated() &&
                  (resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= FAILED PAYOUTS ALERTS (PayPal KYC pending) =================
    match /failed_payouts_alerts/{alertId} {
      // Providers can read their own failed payouts
      allow read: if isAuthenticated() &&
                  (resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= AAA INTERNAL PAYOUTS =================
    // Logs for AAA profiles where money stays on platform
    match /aaa_internal_payouts/{payoutId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Only Cloud Functions
    }

    // ================= AAA EXTERNAL PAYOUTS =================
    // Logs for AAA profiles paid to consolidated external account
    match /aaa_external_payouts/{payoutId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Only Cloud Functions
    }

    // ================= KYC REMINDERS (tracking sent reminders) =================
    match /kyc_reminders/{reminderId} {
      // Only Cloud Functions and admins
      allow read: if isAdmin() || isDev();
      allow write: if false;
    }

    // ================= ESCROW REPORTS (daily monitoring reports) =================
    match /escrow_reports/{reportId} {
      // Only admins can read escrow reports
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= FAILED TRANSFERS LOG =================
    match /failed_transfers_log/{logId} {
      // Only admins can read failed transfer logs
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= CALL RECORDINGS =================
    match /call_recordings/{recordingId} {
      // Only admins can access recordings
      allow read: if isAdmin() || isDev();
      // Only Cloud Functions can write
      allow write: if false;
    }

    // ================= TECHNICAL ALERTS =================
    match /technical_alerts/{alertId} {
      // Only admins/devs can access
      allow read: if isAdmin() || isDev();
      allow update: if isAdmin() || isDev(); // To mark as resolved
      allow create, delete: if false; // Only Cloud Functions
    }

    // ================= ADMIN NOTIFICATIONS =================
    match /admin_notifications/{notificationId} {
      // Only admins can access
      allow read: if isAdmin() || isDev();
      allow update: if isAdmin() || isDev(); // To mark as processed
      allow create, delete: if false; // Only Cloud Functions
    }

    // ================= COST MONITORING =================
    match /cost_metrics/{docId} {
      allow read: if isAdmin();
      allow write: if false; // Cloud Functions only
    }

    match /cost_alerts/{alertId} {
      allow read: if isAdmin();
      allow update: if isAdmin(); // Pour marquer comme lu
      allow create, delete: if false; // Cloud Functions only
    }

    // ================= PROVIDER NOTIFICATIONS COLLECTION =================
    // P0 FIX: Collection pour les notifications des prestataires (pendingRequests, unreadMessages)
    // Utilisée par AiAssistantPageV2.tsx pour afficher les compteurs
    match /provider_notifications/{providerId} {
      // Le provider lui-même peut lire ses notifications
      // Les utilisateurs avec linkedProviderIds peuvent aussi lire (multi-provider)
      allow read: if isAuthenticated() && (
        request.auth.uid == providerId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.linkedProviderIds.hasAny([providerId]) ||
        isAdmin() || isDev()
      );
      // Seules les Cloud Functions peuvent écrire (via Admin SDK)
      allow write: if false;
    }

    // ================= SUBSCRIPTIONS COLLECTION =================
    match /subscriptions/{providerId} {
      // Le provider peut lire son propre abonnement
      allow read: if isOwner(providerId) || isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire (via Admin SDK)
      allow write: if false;
    }

    // ================= SUBSCRIPTION PLANS COLLECTION =================
    match /subscription_plans/{planId} {
      // Lecture publique (pour afficher les prix)
      allow read: if true;
      // Seuls les admins peuvent modifier les plans
      allow write: if isAdmin() || isDev();
    }

    // ================= AI USAGE COLLECTION =================
    match /ai_usage/{userId} {
      // L'utilisateur peut lire son propre usage (providers et clients)
      // Note: Les clients n'auront pas de document, mais peuvent vérifier
      allow read: if isOwner(userId) || isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= SUBSCRIPTION LOGS COLLECTION =================
    match /subscription_logs/{logId} {
      // Seuls les admins peuvent lire les logs d'abonnement
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= SUBSCRIPTION EVENTS COLLECTION =================
    // P0 FIX: Événements d'abonnement pour l'onglet IA Analytics
    // (upgrades, downgrades, cancellations, renewals, trials, etc.)
    match /subscription_events/{eventId} {
      // Lecture: Admin uniquement (données sensibles)
      allow read: if isAdmin() || isDev();
      // Admin peut mettre à jour (acknowledge, notes)
      allow update: if (isAdmin() || isDev()) &&
                    request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['isAcknowledged', 'acknowledgedAt', 'acknowledgedBy',
                               'notes', 'internalNotes', 'updatedAt']);
      // Création: Cloud Functions uniquement (via triggers Stripe)
      allow create, delete: if false;
    }

    // ================= PROCESSED STRIPE EVENTS (Idempotency) =================
    match /processed_stripe_events/{eventId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= QUOTA RESET LOGS =================
    match /quota_reset_logs/{logId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= TRIAL EXPIRATION LOGS =================
    match /trial_expiration_logs/{logId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= PROCESSED WEBHOOK EVENTS (Idempotency) =================
    match /processed_webhook_events/{eventId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= RATE LIMITS (Anti-abuse) =================
    match /rate_limits/{limitId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= ADMIN AUDIT LOGS (Compliance) =================
    match /admin_audit_logs/{logId} {
      // Seuls les admins peuvent lire les logs d'audit
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire (immuable)
      allow write: if false;
    }

    // ================= RESTORE OPERATIONS (Backup Restore Tracking) =================
    match /restore_operations/{operationId} {
      // Seuls les admins peuvent lire les opérations de restauration
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= INVOICE RECORDS (Prestations) =================
    match /invoice_records/{invoiceId} {
      // Les utilisateurs peuvent lire leurs propres factures (client ou provider)
      allow read: if isAuthenticated() &&
                  (resource.data.clientId == request.auth.uid ||
                   resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());
      // Le client peut créer une facture dont il est le client
      // (sécurisé: on vérifie que clientId == uid de l'utilisateur)
      allow create: if isAuthenticated() &&
                    request.resource.data.clientId == request.auth.uid;
      // Seuls admins peuvent modifier/supprimer
      allow update, delete: if isAdmin() || isDev();
    }

    // ================= ADMIN INVOICES (Console admin) =================
    // P1 SECURITY FIX: Only Cloud Functions can create admin invoices
    match /admin_invoices/{invoiceId} {
      // Seuls les admins peuvent accéder
      allow read: if isAdmin() || isDev();
      // P1 FIX: Only Cloud Functions via Admin SDK can create
      allow create: if false;
      allow update, delete: if isAdmin() || isDev();
    }

    // ================= AUDIT LOGS (Facturation) =================
    // P1 SECURITY FIX: Only Cloud Functions can create audit logs
    match /audit_logs/{logId} {
      // Seuls les admins peuvent lire les logs
      allow read: if isAdmin() || isDev();
      // P1 FIX: Only Cloud Functions via Admin SDK can create (prevents log forgery)
      allow create: if false;
      allow update, delete: if isAdmin() || isDev();
    }

    // ================= LEGAL DOCUMENTS COLLECTION =================
    // Documents légaux (CGU, CGV, Politique de confidentialité, etc.)
    match /legal_documents/{docId} {
      // Lecture publique pour les pages légales
      allow read: if true;
      // Seuls les admins peuvent modifier
      allow write: if isAdmin() || isDev();
    }

    // ================= ADMIN SETTINGS COLLECTION =================
    // Paramètres d'administration
    match /admin_settings/{docId} {
      // Seuls les admins peuvent lire et écrire
      allow read, write: if isAdmin() || isDev();
    }

    // ================= AUTH CLAIMS LOGS COLLECTION =================
    // Logs des changements de claims auth
    match /auth_claims_logs/{logId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= COUNTRY SETTINGS COLLECTION =================
    // Paramètres des pays activés/désactivés
    match /country_settings/{countryId} {
      // Lecture publique pour charger les pays activés sur le frontend
      allow read: if true;
      // Seuls les admins peuvent modifier
      allow write: if isAdmin() || isDev();
    }

    // ================= BOOKING REQUESTS COLLECTION =================
    match /booking_requests/{bookingId} {
      // Lecture : client ou provider concerné, ou admin/dev
      allow read: if isAuthenticated() &&
                  (resource.data.clientId == request.auth.uid ||
                   resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());

      // Création : client authentifié avec validation des champs requis
      allow create: if isAuthenticated() &&
                    request.resource.data.clientId == request.auth.uid &&
                    request.resource.data.providerId is string &&
                    request.resource.data.serviceType is string &&
                    request.resource.data.status == "pending";

      // Mise à jour : client ou provider concerné (pour changer le statut, etc.)
      allow update: if isAuthenticated() &&
                    (resource.data.clientId == request.auth.uid ||
                     resource.data.providerId == request.auth.uid ||
                     isAdmin() || isDev());

      // Suppression : admin uniquement
      allow delete: if isAdmin() || isDev();
    }

    // ================= AUTH LOGS COLLECTION =================
    match /auth_logs/{logId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Utilisateurs authentifiés peuvent créer leurs propres logs
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      // Cloud Functions seules peuvent modifier/supprimer
      allow update, delete: if false;
    }

    // ================= LOGS COLLECTION (Auth Events) =================
    // Collection utilisée par logAuthEvent() dans AuthContext
    match /logs/{logId} {
      // Seuls les admins peuvent lire les logs
      allow read: if isAdmin() || isDev();
      // Utilisateurs authentifiés peuvent créer des logs
      allow create: if isAuthenticated();
      // Cloud Functions seules peuvent modifier/supprimer
      allow update, delete: if false;
    }

    // ================= ERROR LOGS COLLECTION =================
    match /error_logs/{logId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Utilisateurs authentifiés peuvent logger les erreurs
      allow create: if isAuthenticated();
      // Cloud Functions seules peuvent modifier/supprimer
      allow update, delete: if false;
    }

    // ================= PERFORMANCE METRICS COLLECTION =================
    // P0 FIX: Permet aux utilisateurs authentifiés de logger les métriques de performance
    // (ex: temps de génération des factures, latence des appels, etc.)
    match /performance_metrics/{metricId} {
      // Seuls les admins peuvent lire les métriques
      allow read: if isAdmin() || isDev();
      // Utilisateurs authentifiés peuvent créer des métriques
      allow create: if isAuthenticated();
      // Cloud Functions seules peuvent modifier/supprimer
      allow update, delete: if false;
    }

    // ================= INVOICE LOCKS COLLECTION =================
    // P0-3 FIX: Distributed lock pour empêcher la génération de factures en double
    // Géré via Cloud Functions (acquireInvoiceLock, releaseInvoiceLock)
    match /invoice_locks/{lockId} {
      // Lecture pour vérifier si un lock existe
      allow read: if isAuthenticated();
      // Création/modification/suppression via Cloud Functions uniquement
      allow create, update, delete: if false;
    }

    // ================= NOTIFICATION DLQ COLLECTION =================
    // P1-6 FIX: Dead Letter Queue pour les notifications échouées
    match /notification_dlq/{docId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Cloud Functions seules peuvent créer/modifier
      allow create, update, delete: if false;
    }

    // ================= SCHEDULING ERRORS COLLECTION =================
    // Logs des erreurs de planification d'appels
    match /scheduling_errors/{errorId} {
      allow read: if isAdmin() || isDev();
      allow create: if false; // Cloud Functions only
      allow update, delete: if false;
    }

    // ================= ANALYTICS EVENTS COLLECTION =================
    match /analytics_events/{eventId} {
      // Seuls les admins peuvent lire
      allow read: if isAdmin() || isDev();
      // Utilisateurs authentifiés peuvent créer des événements
      allow create: if isAuthenticated();
      // Cloud Functions seules peuvent modifier/supprimer
      allow update, delete: if false;
    }

    // ================= ANALYTICS LANGUAGE MISMATCHES =================
    match /analytics_language_mismatches/{eventId} {
      allow read: if isAdmin() || isDev();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ================= ANALYTICS USER ACTIONS =================
    match /analytics_user_actions/{eventId} {
      allow read: if isAdmin() || isDev();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ================= ANALYTICS CONVERSIONS =================
    match /analytics_conversions/{eventId} {
      allow read: if isAdmin() || isDev();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ================= ANALYTICS ERRORS =================
    match /analytics_errors/{eventId} {
      allow read: if isAdmin() || isDev();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ================= ANALYTICS PERFORMANCE =================
    match /analytics_performance/{eventId} {
      allow read: if isAdmin() || isDev();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // ================= ANALYTICS COUNTERS =================
    // P0 SECURITY FIX: Seules les Cloud Functions peuvent manipuler les compteurs
    // Empêche la manipulation des métriques par des utilisateurs malveillants
    match /analytics_counters/{counterId} {
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions via Admin SDK peuvent écrire
      allow write: if false;
    }

    // ================= AD CONVERSIONS (Attribution Publicitaire) =================
    // Collection pour tracker les conversions avec attribution de source de trafic
    // (Facebook Ads, Google Ads, TikTok, etc.)
    match /ad_conversions/{conversionId} {
      // Seuls les admins peuvent lire les données d'attribution
      allow read: if isAdmin() || isDev();
      // Tout utilisateur authentifié peut créer une conversion (tracking)
      // Même non-auth pour permettre le tracking des visiteurs anonymes
      allow create: if true;
      // Les conversions ne peuvent jamais être modifiées ou supprimées (audit trail)
      allow update, delete: if false;
    }

    // ================= FAQ TRANSLATIONS CACHE =================
    match /faq_translations_cache/{cacheId} {
      // Lecture publique pour les FAQ traduites
      allow read: if true;
      // Seuls les admins peuvent écrire
      allow write: if isAdmin() || isDev();
    }

    // ================= CONTACT MESSAGES COLLECTION =================
    // Messages de contact depuis le formulaire footer et page contact
    // P0 SECURITY: Création via Cloud Function avec reCAPTCHA pour éviter le spam
    match /contact_messages/{messageId} {
      // Seuls les admins peuvent lire les messages de contact
      allow read: if isAdmin() || isDev();
      // P0 SECURITY: Création désactivée directement depuis le client
      // Utiliser la Cloud Function createContactMessage avec reCAPTCHA
      // Cette protection évite le spam et les attaques "denial of wallet"
      allow create: if false;
      // Seuls les admins peuvent mettre à jour (marquer comme lu, répondre)
      allow update: if isAdmin() || isDev();
      // Seuls les admins peuvent supprimer
      allow delete: if isAdmin() || isDev();
    }

    // ================= USER REPORTS COLLECTION =================
    // Signalements utilisateurs (avis inappropriés, profils suspects, etc.)
    match /reports/{reportId} {
      // L'utilisateur peut lire ses propres signalements, admins peuvent tout lire
      allow read: if isAuthenticated() &&
                  (resource.data.reporterId == request.auth.uid || isAdmin() || isDev());

      // Utilisateurs authentifiés peuvent créer un signalement
      // - Doit être le reporter (pas d'usurpation)
      // - Ne peut pas se signaler soi-même
      // - Doit avoir une raison valide
      allow create: if isAuthenticated() &&
                    request.resource.data.reporterId == request.auth.uid &&
                    request.resource.data.targetId != request.auth.uid &&
                    request.resource.data.reason is string &&
                    request.resource.data.reason.size() >= 5;

      // Seuls les admins peuvent mettre à jour (résoudre, rejeter)
      allow update: if isAdmin() || isDev();

      // Seuls les admins peuvent supprimer
      allow delete: if isAdmin() || isDev();
    }

    // ================= EMAIL LOGS COLLECTION =================
    // Logs des emails envoyés (pour traçabilité)
    match /email_logs/{logId} {
      // Seuls les admins peuvent lire les logs
      allow read: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent écrire
      allow write: if false;
    }

    // ================= SECURITY ALERTS COLLECTION =================
    // Alertes de sécurité (brute force, fraude, etc.)
    // NOTE: Aucun pays n'est blacklisté - détection basée sur comportements anormaux
    match /security_alerts/{alertId} {
      // Seuls les admins peuvent lire les alertes de sécurité
      allow read: if isAdmin() || isDev();
      // Admins peuvent mettre à jour (acknowledge, resolve)
      allow update: if isAdmin() || isDev();
      // Seules les Cloud Functions peuvent créer/supprimer
      allow create, delete: if false;
    }

    // ================= ALERT RATE LIMITS =================
    // Rate limiting pour éviter le spam d'alertes
    match /alert_rate_limits/{limitId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Cloud Functions only
    }

    // ================= ADMIN ALERT PREFERENCES =================
    // Préférences de notification des admins
    match /admin_alert_preferences/{adminId} {
      // Admin peut lire/modifier ses propres préférences
      allow read: if isOwner(adminId) || isAdmin() || isDev();
      allow write: if isOwner(adminId) || isAdmin() || isDev();
    }

    // ================= THREAT SCORES =================
    // Scores de menace par utilisateur/IP
    match /threat_scores/{entityId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Cloud Functions only
    }

    // ================= BLOCKED ENTITIES =================
    // Entités bloquées (utilisateurs, IPs)
    match /blocked_entities/{entityId} {
      allow read: if isAdmin() || isDev();
      // Admins peuvent débloquer manuellement
      allow update, delete: if isAdmin() || isDev();
      allow create: if false; // Cloud Functions only
    }

    // ================= GEO PROFILES =================
    // Profils géographiques des utilisateurs (pour détection anomalies)
    match /geo_profiles/{userId} {
      // L'utilisateur peut voir son propre profil, admins tout
      allow read: if isOwner(userId) || isAdmin() || isDev();
      allow write: if false; // Cloud Functions only
    }

    // ================= FRAUD PATTERNS =================
    // Patterns de fraude détectés
    match /fraud_patterns/{patternId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Cloud Functions only
    }

    // ================= API ABUSE LOGS =================
    // Logs d'abus API (scraping, injection, etc.)
    match /api_abuse_logs/{logId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Cloud Functions only
    }

    // ================= SECURITY EVENTS (raw events) =================
    // Événements de sécurité bruts avant traitement
    match /security_events/{eventId} {
      allow read: if isAdmin() || isDev();
      allow write: if false; // Cloud Functions only
    }

    // ================= LOGIN ATTEMPTS =================
    // Tentatives de login (pour détection brute force)
    match /login_attempts/{attemptId} {
      allow read: if isAdmin() || isDev();
      // Les Cloud Functions créent les entrées lors des tentatives de connexion
      allow write: if false;
    }

    // ================= ADMIN SECURITY ACTIONS =================
    // Actions de sécurité prises par les admins (audit trail)
    match /admin_security_actions/{actionId} {
      allow read: if isAdmin() || isDev();
      // Admins peuvent créer des actions (avec leur uid)
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if false; // Immutable audit trail
    }

    // ================= SECURITY ROUTING CONFIG =================
    // Configuration du routing des alertes de sécurité
    match /security_routing/{configId} {
      allow read: if isAdmin() || isDev();
      allow write: if isAdmin() || isDev();
    }

    // =====================================================================
    // SECTION COMPTABILITE / FINANCE - NOUVELLES COLLECTIONS
    // Roles: SUPER_ADMIN, FINANCE_ADMIN, VIEWER
    // =====================================================================

    // ================= HELPER FUNCTIONS FINANCE =================
    // Note: Ces fonctions sont deja definies en haut du fichier
    // Elles acceptent les roles: admin, FINANCE_ADMIN, SUPER_ADMIN

    // ================= COUNTRY TAX CONFIGS =================
    // Configuration fiscale par pays (taux TVA, seuils, etc.)
    match /country_tax_configs/{countryCode} {
      // Lecture: tout utilisateur authentifie (pour afficher les prix TTC)
      allow read: if isAuthenticated();
      // Ecriture: FINANCE_ADMIN ou SUPER_ADMIN uniquement
      allow create, update: if isFinanceAdmin();
      allow delete: if isSuperAdmin();
    }

    // ================= TAX CONFIGS =================
    // Configuration TVA par pays (taux standard, reduit, etc.)
    match /tax_configs/{countryCode} {
      // Lecture: admin uniquement (donnees sensibles)
      allow read: if isAdmin();
      // Ecriture: admin uniquement
      allow write: if isAdmin();
    }

    // ================= COUNTRIES =================
    // Liste des pays (pour les selecteurs)
    match /countries/{countryId} {
      // Lecture: tout utilisateur authentifie
      allow read: if isAuthenticated();
      // Ecriture: admin uniquement
      allow write: if isAdmin();
    }

    // ================= TAX DECLARATIONS =================
    // Declarations TVA par pays/periode
    match /tax_declarations/{declarationId} {
      // Lecture: admin uniquement
      allow read: if isAdmin();
      // Ecriture: admin uniquement
      allow write: if isAdmin();
    }

    // ================= THRESHOLD TRACKING =================
    // Suivi des seuils de CA par pays (pour obligations fiscales)
    match /threshold_tracking/{trackingId} {
      // Lecture: admin (donnees sensibles)
      allow read: if isAdmin();
      // Ecriture: admin ou Cloud Functions
      allow write: if isAdmin();
    }

    // ================= THRESHOLD ALERTS =================
    // Alertes quand un seuil est proche ou atteint
    match /threshold_alerts/{alertId} {
      // Lecture: admin
      allow read: if isAdmin();
      // Ecriture: admin
      allow write: if isAdmin();
    }

    // ================= JOURNAL ENTRIES =================
    // Ecritures comptables (debit/credit)
    // IMMUTABILITE: une ecriture POSTED ne peut plus etre modifiee
    match /journal_entries/{entryId} {
      // Lecture: FINANCE_ADMIN ou SUPER_ADMIN
      allow read: if isFinanceAdmin();
      // Creation: Cloud Functions uniquement (genere automatiquement)
      allow create: if false;
      // Update: FINANCE_ADMIN peut faire passer DRAFT -> POSTED uniquement
      // Une fois POSTED, plus aucune modification possible
      allow update: if isFinanceAdmin() &&
                    resource.data.status == 'DRAFT' &&
                    request.resource.data.status in ['DRAFT', 'POSTED'] &&
                    // Seuls ces champs peuvent etre modifies en DRAFT
                    request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['status', 'postedAt', 'postedBy', 'notes', 'description']);
      // Delete: JAMAIS (immutabilite comptable)
      allow delete: if false;
    }

    // ================= CHART OF ACCOUNTS =================
    // Plan comptable (liste des comptes: 411000 Clients, 701000 Ventes, etc.)
    match /chart_of_accounts/{accountCode} {
      // Lecture: FINANCE_ADMIN ou SUPER_ADMIN
      allow read: if isFinanceAdmin();
      // Ecriture: SUPER_ADMIN uniquement (modification du plan comptable = risque)
      allow create, update, delete: if isSuperAdmin();
    }

    // ================= ACCOUNTING PERIODS =================
    // Periodes comptables (mois, trimestres, annees)
    match /accounting_periods/{periodId} {
      // Lecture: FINANCE_ADMIN ou SUPER_ADMIN
      allow read: if isFinanceAdmin();
      // Creation/Suppression: SUPER_ADMIN uniquement
      allow create, delete: if isSuperAdmin();
      // Update: FINANCE_ADMIN peut cloturer une periode (status: OPEN -> CLOSED)
      // SUPER_ADMIN peut tout modifier
      allow update: if isSuperAdmin() ||
                    (isFinanceAdmin() &&
                     resource.data.status == 'OPEN' &&
                     request.resource.data.status == 'CLOSED' &&
                     request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['status', 'closedAt', 'closedBy']));
    }

    // ================= TAX FILINGS =================
    // Declarations fiscales (TVA mensuelle, trimestrielle, annuelle)
    match /tax_filings/{filingId} {
      // Lecture: FINANCE_ADMIN ou SUPER_ADMIN
      allow read: if isFinanceAdmin();
      // Creation: Cloud Functions uniquement (genere automatiquement)
      allow create: if false;
      // Update: FINANCE_ADMIN peut changer le statut et ajouter des notes
      allow update: if isFinanceAdmin() &&
                    request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['status', 'filedAt', 'filedBy', 'referenceNumber',
                               'notes', 'attachments', 'submittedAt', 'submittedBy']);
      // Delete: JAMAIS (obligation legale de conservation)
      allow delete: if false;
    }

    // ================= VAT VALIDATIONS =================
    // Cache des validations de numeros de TVA intracommunautaire (VIES)
    match /vat_validations/{validationId} {
      // Lecture: tout utilisateur authentifie (pour checkout B2B)
      allow read: if isAuthenticated();
      // Ecriture: Cloud Functions uniquement (via API VIES)
      allow write: if false;
    }

    // ================= COUNTRY PRICING =================
    // Prix par pays (conversion devises, ajustements locaux)
    match /country_pricing/{countryCode} {
      // Lecture: tout utilisateur authentifie (pour afficher les prix)
      allow read: if isAuthenticated();
      // Ecriture: SUPER_ADMIN uniquement (impact business majeur)
      allow write: if isSuperAdmin();
    }

    // ================= RECONCILIATION RECORDS =================
    // Rapprochements bancaires et comptables
    match /reconciliation_records/{recordId} {
      // Lecture: FINANCE_ADMIN ou SUPER_ADMIN
      allow read: if isFinanceAdmin();
      // Ecriture: FINANCE_ADMIN ou SUPER_ADMIN
      allow create, update: if isFinanceAdmin();
      // Delete: SUPER_ADMIN uniquement (pour correction d'erreurs)
      allow delete: if isSuperAdmin();
    }

    // ================= FINANCE AUDIT LOGS =================
    // Logs d'audit specifiques aux operations comptables
    // Toute modification comptable doit etre tracee ici
    match /finance_audit_logs/{logId} {
      // Lecture: FINANCE_ADMIN ou SUPER_ADMIN
      allow read: if isFinanceAdmin();
      // Ecriture: Cloud Functions uniquement (audit automatique)
      allow write: if false;
    }

    // ================= TAX FILINGS COLLECTION =================
    // Declarations fiscales (TVA Estonie, OSS UE, DES, UK VAT, CH VAT)
    // SECURITE: Donnees fiscales sensibles - acces admin uniquement
    match /tax_filings/{filingId} {
      // Lecture: Admin uniquement (donnees fiscales confidentielles)
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement via Admin SDK
      // Les modifications passent par generateTaxFiling, updateFilingStatus, etc.
      allow write: if false;
    }

    // ================= TAX FILING NOTIFICATIONS =================
    // Rappels automatiques pour echeances fiscales
    match /tax_filing_notifications/{notifId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement
      allow write: if false;
    }

    // ================= TAX FILING CONFIGS =================
    // Configuration par type de declaration (seuils, emails de notification)
    match /tax_filing_configs/{configId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Admin uniquement (configuration manuelle)
      allow write: if isAdmin();
    }

    // ================= COUNTRY FISCAL CONFIGS =================
    // Configuration fiscale complete pour 197 pays
    // (VAT/GST/Sales Tax, seuils, regimes digital services, etc.)
    match /country_fiscal_configs/{countryCode} {
      // Lecture publique (pour afficher prix TTC, info paiement)
      allow read: if true;
      // Ecriture: Admin uniquement (Cloud Functions pour seed)
      allow write: if isAdmin() || isDev();
    }

    // ================= COUNTRY SUBDIVISIONS =================
    // USA states (51) + Canada provinces (13)
    // Taxes specifiques par etat/province (Sales Tax, GST/HST/PST/QST)
    match /country_subdivisions/{subdivisionId} {
      // Lecture publique (pour calculs de taxe)
      allow read: if true;
      // Ecriture: Admin uniquement
      allow write: if isAdmin() || isDev();
    }

    // ================= SYSTEM ALERTS =================
    // Alertes systeme critiques (DLQ, backups, disputes, erreurs)
    // Cloud Functions creent les alertes, admin les lit et acquitte
    match /system_alerts/{alertId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Creation: Cloud Functions uniquement (via Admin SDK)
      allow create: if false;
      // Mise a jour: Admin peut acquitter les alertes
      allow update: if isAdmin();
      // Suppression: Admin uniquement (cleanup)
      allow delete: if isAdmin();
    }

    // ================= WEBHOOK DLQ (Dead Letter Queue) =================
    // Evenements webhook en echec pour retry manuel
    match /webhook_dlq/{eventId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement
      allow write: if false;
    }

    // ================= RATE LIMITS =================
    // Limites de taux pour protection anti-spam
    match /rate_limits/{limitId} {
      // Lecture: Admin uniquement (debug)
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement
      allow write: if false;
    }

    // ================= ERROR LOGS =================
    // Logs d'erreurs systeme
    match /error_logs/{logId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Creation: Utilisateurs authentifies peuvent logger des erreurs
      allow create: if isAuthenticated();
      // Mise a jour/suppression: Cloud Functions uniquement
      allow update, delete: if false;
    }

    // ================= SYSTEM LOGS =================
    // Logs systeme (backups, migrations, etc.)
    match /system_logs/{logId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement
      allow write: if false;
    }

    // ================= PROVIDER STATUS LOGS =================
    // Logs de changement de statut des prestataires (busy/available)
    // Utilisé pour le feature shareBusyStatus (multi-providers)
    match /provider_status_logs/{logId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement
      allow write: if false;
    }

    // ================= AUTH BACKUPS =================
    // Metadonnees des backups Firebase Auth
    match /auth_backups/{backupId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement
      allow write: if false;
    }

    // ================= MAIL (Firebase Email Extension) =================
    // Collection pour envoi d'emails via extension
    match /mail/{mailId} {
      // Lecture: Admin uniquement (debug)
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement
      allow write: if false;
    }

    // ================= DR TEST REPORTS =================
    // Rapports de tests Disaster Recovery
    match /dr_test_reports/{reportId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement
      allow write: if false;
    }

    // ================= SYSTEM CONFIG =================
    // Configuration systeme (seuils d'alertes, etc.)
    match /system_config/{configId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Admin uniquement
      allow write: if isAdmin();
    }

    // ================= VALIDATION QUEUE =================
    // File d'attente de validation des profils prestataires
    // Audit trail: suppression interdite pour tracabilite complete
    match /validation_queue/{validationId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Creation: Cloud Functions uniquement (via Admin SDK)
      allow create: if false;
      // Mise a jour: Admin uniquement (pour valider/rejeter)
      allow update: if isAdmin();
      // Suppression: JAMAIS (audit trail obligatoire)
      allow delete: if false;

      // Sous-collection: historique des validations
      match /validation_history/{historyId} {
        // Lecture: Admin uniquement
        allow read: if isAdmin();
        // Ecriture: Cloud Functions uniquement (via Admin SDK)
        allow write: if false;
      }
    }

    // ================= PROVIDER ACTION LOGS =================
    // Logs des actions des prestataires (connexion, deconnexion, modifications profil)
    // Immutable: ecriture Cloud Functions uniquement
    match /provider_action_logs/{logId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement (via Admin SDK)
      allow write: if false;
    }

    // ================= CONNECTION LOGS =================
    // Logs de connexion/deconnexion des utilisateurs
    // Immutable apres creation: pas de modification ni suppression
    match /connection_logs/{logId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Creation: Cloud Functions uniquement (via Admin SDK)
      // Note: Les Cloud Functions valident les champs requis (userId, timestamp, eventType, etc.)
      allow create: if false;
      // Mise a jour: JAMAIS (immutable)
      allow update: if false;
      // Suppression: JAMAIS (audit trail)
      allow delete: if false;
    }

    // ================= SERVICE BALANCE ALERTS =================
    // Alertes sur les soldes de services (credits faibles, etc.)
    match /service_balance_alerts/{alertId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Admin uniquement (pour acquitter les alertes)
      allow write: if isAdmin();
    }

    // ================= SERVICE BALANCE THRESHOLDS =================
    // Configuration des seuils d'alerte pour les soldes de services
    match /service_balance_thresholds/{thresholdId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Admin uniquement
      allow write: if isAdmin();
    }

    // ================= ANALYTICS DAILY =================
    // Metriques analytiques agregees par jour
    // Immutable: genere automatiquement par Cloud Functions
    match /analytics_daily/{dateId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin();
      // Ecriture: Cloud Functions uniquement (via Admin SDK)
      allow write: if false;
    }

    // ================= AI CALL LOGS =================
    // Logs des appels IA (GPT, Claude, Perplexity, etc.)
    // Usage: Console admin pour monitoring des couts et performances IA
    match /ai_call_logs/{logId} {
      // Lecture: Admin uniquement (donnees sensibles - couts, tokens)
      allow read: if isAdmin() || isDev();
      // Ecriture: Cloud Functions uniquement (via Admin SDK)
      allow write: if false;
    }

    // ================= OPENAI USAGE METRICS =================
    // Metriques d'utilisation OpenAI (tokens, couts par modele)
    // Usage: Console admin - onglet IA Analytics
    match /openai_usage_metrics/{metricId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin() || isDev();
      // Ecriture: Cloud Functions uniquement (via Admin SDK)
      allow write: if false;
    }

    // ================= SERVICE ALERTS =================
    // Alertes des services externes (Twilio, Stripe, OpenAI, etc.)
    // Usage: Console admin - widget alertes services
    match /service_alerts/{alertId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin() || isDev();
      // Mise a jour: Admin peut acquitter les alertes
      allow update: if isAdmin() || isDev();
      // Creation/Suppression: Cloud Functions uniquement
      allow create, delete: if false;
    }

    // ================= USER FEEDBACK =================
    // Feedbacks utilisateurs (bugs, suggestions, problèmes UX)
    // Usage: Formulaire de signalement accessible à tous
    match /user_feedback/{feedbackId} {
      // Lecture: Admin uniquement (console admin)
      allow read: if isAdmin() || isDev();
      // Création: Tous (même non authentifiés) avec validation
      // - email requis et format valide
      // - type requis (bug, ux_friction, suggestion, other)
      // - description requise (min 10 caractères)
      // NOTE: .size() compte les BYTES UTF-8, pas les caractères!
      // Les caractères français (é, è, à) = 2 bytes chacun
      // On utilise 6000 bytes pour permettre ~2000 caractères UTF-8
      allow create: if request.resource.data.keys().hasAll(['email', 'type', 'description'])
                    && request.resource.data.email is string
                    && request.resource.data.email.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$')
                    && request.resource.data.type in ['bug', 'ux_friction', 'suggestion', 'other']
                    && request.resource.data.description is string
                    && request.resource.data.description.size() >= 10
                    && request.resource.data.description.size() <= 6000;
      // Mise à jour/Suppression: Admin uniquement
      allow update, delete: if isAdmin() || isDev();
    }

    // ================= CAPI EVENTS (Meta Conversion API) =================
    // Événements Meta CAPI pour le tableau de bord analytics
    // Utilisé par: AdminMetaAnalytics, useMetaAnalytics hook
    match /capi_events/{eventId} {
      // Lecture: Admin uniquement (données analytiques sensibles)
      allow read: if isAdmin() || isDev();
      // Écriture: Cloud Functions uniquement via Admin SDK
      allow create, update, delete: if false;
    }

    // ================= GOOGLE ADS EVENTS =================
    // Événements Google Ads Enhanced Conversions
    // Utilisé par: AdminGoogleAdsAnalytics, useGoogleAdsAnalytics hook
    match /google_ads_events/{eventId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin() || isDev();
      // Écriture: Cloud Functions uniquement via Admin SDK
      allow create, update, delete: if false;
    }

    // ================= COUPON USAGES =================
    // Historique d'utilisation des codes promo
    // Utilisé par: AdminPromoCodes pour les statistiques
    match /coupon_usages/{usageId} {
      // Lecture: Admin uniquement
      allow read: if isAdmin() || isDev();
      // Écriture: Cloud Functions uniquement via Admin SDK
      allow create, update, delete: if false;
    }

    // ================= SCHEDULED REPORTS =================
    // Rapports planifiés pour Meta Analytics
    match /scheduled_reports/{reportId} {
      // Lecture/Écriture: Admin uniquement
      allow read, write: if isAdmin() || isDev();
    }

    // ================= CONVERSATIONS (IA TOOL) =================
    // Historique des conversations IA entre clients et prestataires
    match /conversations/{conversationId} {
      // Lecture: client, provider concerné, ou admin
      allow read: if isAuthenticated() &&
                  (resource.data.clientId == request.auth.uid ||
                   resource.data.providerId == request.auth.uid ||
                   isAdmin() || isDev());

      // Création: utilisateur authentifié (client ou Cloud Functions)
      allow create: if isAuthenticated();

      // Mise à jour: participants ou admin
      allow update: if isAuthenticated() &&
                    (resource.data.clientId == request.auth.uid ||
                     resource.data.providerId == request.auth.uid ||
                     isAdmin() || isDev());

      // Suppression: admin seulement
      allow delete: if isAdmin() || isDev();

      // Sous-collection messages
      match /messages/{messageId} {
        // Lecture: participants de la conversation parent
        allow read: if isAuthenticated() &&
                    (get(/databases/$(database)/documents/conversations/$(conversationId)).data.clientId == request.auth.uid ||
                     get(/databases/$(database)/documents/conversations/$(conversationId)).data.providerId == request.auth.uid ||
                     isAdmin() || isDev());

        // Création: participants authentifiés
        allow create: if isAuthenticated() &&
                      (get(/databases/$(database)/documents/conversations/$(conversationId)).data.clientId == request.auth.uid ||
                       get(/databases/$(database)/documents/conversations/$(conversationId)).data.providerId == request.auth.uid ||
                       isAdmin() || isDev());

        // Mise à jour/Suppression: admin seulement
        allow update, delete: if isAdmin() || isDev();
      }
    }

    // ================= CATCH-ALL (deny by default) =================
    // SECURITE: Refuse TOUT acces non explicitement autorise
    // Le role 'dev' est desactive en production
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
