rules_version = '2';

// ==========================================
// FIRESTORE DATABASE RULES
// ==========================================
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function : vérifier si l'utilisateur est admin
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.role == 'admin';
    }
    
    // Collection de tracking du contenu utilisé (bios, reviews)
    match /aaa_used_content/{documentId} {
      // Lecture : Admins seulement
      allow get, list: if isAdmin();
      
      // Écriture : Admins seulement avec validation de structure
      allow create: if isAdmin() && 
                       request.resource.data.keys().hasAll(['type', 'langCode', 'usedAt']) &&
                       request.resource.data.type in ['bio', 'review'];
      
      // Pas de mise à jour ni suppression (données append-only)
      allow update, delete: if false;
    }
    
    // ================= FAQ COLLECTION =================
    match /faqs/{faqId} {
      // Read: Everyone can read active FAQs
      allow read: if resource.data.isActive == true;
      
      // Write: Only admins
      allow create, update, delete: if isAdmin();
    }
    
    // ... ajoutez vos autres règles Firestore existantes ici ...
  }
}

// ==========================================
// FIREBASE STORAGE RULES
// ==========================================
service firebase.storage {
  match /b/{bucket}/o {
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }
    
    function isDevMode() {
      return exists(/databases/(default)/documents/settings/env) && 
             get(/databases/(default)/documents/settings/env).data.mode == 'dev';
    }
    
    function isValidFileSize() {
      return request.resource != null && request.resource.size < 15 * 1024 * 1024;
    }
    
    function isImage() {
      return request.resource != null && request.resource.contentType.matches('image/.*');
    }
    
    function isValidDocumentType() {
      return request.resource != null && request.resource.contentType in [
        'application/pdf', 'image/jpeg', 'image/png', 'image/webp',
        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      ];
    }

    match /profilePhotos/{userId}/{fileName} {
      allow read: if true;
      allow write: if (isAuthenticated() && request.auth.uid == userId && isImage() && isValidFileSize()) || isAdmin();
      allow delete: if (isAuthenticated() && (request.auth.uid == userId || isAdmin()));
    }

    match /registration_temp/{fileName} {
      allow read: if true;
      allow write: if isImage() && isValidFileSize();
      allow delete: if isAdmin();
    }

    match /temp_profiles/{fileName} {
      allow read: if true;
      allow write: if isImage() && isValidFileSize();
      allow delete: if isAdmin();
    }

    match /profile_photos/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isImage() && isValidFileSize();
      allow delete: if isAuthenticated();
    }

    match /documents/{userId}/{fileName} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && request.auth.uid == userId && isValidDocumentType() && isValidFileSize();
      allow delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin()));
    }

    // Factures par utilisateur (legacy)
    match /invoices/{userId}/{fileName} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write, delete: if isAdmin() && isValidDocumentType() && isValidFileSize();
    }

    // Factures prestations (platform et provider)
    match /invoices/{invoiceType}/{year}/{month}/{fileName} {
      // Lecture: utilisateurs authentifiés (les URLs sont signées)
      allow read: if isAuthenticated();
      // Écriture: utilisateurs authentifiés peuvent créer des factures PDF
      allow create: if isAuthenticated() &&
                    request.resource.contentType == 'application/pdf' &&
                    request.resource.size < 5 * 1024 * 1024;
      // Suppression: admins uniquement
      allow delete: if isAdmin();
    }

    match /backups/{fileName} {
      allow read, write: if isAdmin();
    }

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}