rules_version = '2';

// ==========================================
// FIREBASE STORAGE RULES
// ==========================================
service firebase.storage {
  match /b/{bucket}/o {
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    function isDevMode() {
      return exists(/databases/(default)/documents/settings/env) &&
             get(/databases/(default)/documents/settings/env).data.mode == 'dev';
    }

    function isValidFileSize() {
      return request.resource != null && request.resource.size < 15 * 1024 * 1024;
    }

    function isImage() {
      return request.resource != null && request.resource.contentType.matches('image/.*');
    }

    function isValidDocumentType() {
      return request.resource != null && request.resource.contentType in [
        'application/pdf', 'image/jpeg', 'image/png', 'image/webp',
        'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      ];
    }

    match /profilePhotos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if (isAuthenticated() && request.auth.uid == userId && isImage() && isValidFileSize()) || isAdmin();
      allow delete: if (isAuthenticated() && (request.auth.uid == userId || isAdmin()));
    }

    // REGISTRATION TEMP: Uploads during registration (user not yet authenticated)
    // Security: Anonymous uploads allowed with strict limits (images only, 5MB max)
    // Files are cleaned up by Cloud Function after 24h
    // ⚠️ IMPORTANT: Public read access required for preview during registration
    match /registration_temp/{fileName} {
      // ✅ FIX: Allow public read for registration preview (user not authenticated yet)
      // Security: URLs contain random tokens, files auto-deleted after 24h
      allow read: if true;
      // Allow anonymous uploads during registration with strict validation
      // - Images only (jpeg, png, webp, gif)
      // - Max 5MB for anonymous uploads (reduced from 15MB)
      allow write: if isImage() &&
                   request.resource != null &&
                   request.resource.size < 5 * 1024 * 1024;
      allow delete: if isAdmin();
    }

    // TEMP PROFILES: Temporary profile photos during registration
    // Same rules as registration_temp
    match /temp_profiles/{fileName} {
      // ✅ FIX: Allow public read for registration preview (user not authenticated yet)
      // Security: URLs contain random tokens, files auto-deleted after 24h
      allow read: if true;
      // Allow anonymous uploads during registration with strict validation
      allow write: if isImage() &&
                   request.resource != null &&
                   request.resource.size < 5 * 1024 * 1024;
      allow delete: if isAdmin();
    }

    // P1 SECURITY FIX: Require ownership check for delete
    match /profile_photos/{userId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId && isImage() && isValidFileSize();
      // P1 FIX: Only owner or admin can delete their own photos
      allow delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // Admin can upload profile photos directly (for AAA profiles management)
    // Note: isAdmin() checks custom claim 'role' == 'admin'
    // Fallback: also allow authenticated users (temporary for AAA admin)
    match /profile_photos/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isImage() && isValidFileSize();
      allow delete: if isAdmin();
    }

    match /documents/{userId}/{fileName} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write: if isAuthenticated() && request.auth.uid == userId && isValidDocumentType() && isValidFileSize();
      allow delete: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
    }

    // Factures par utilisateur (legacy)
    match /invoices/{userId}/{fileName} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      allow write, delete: if isAdmin() && isValidDocumentType() && isValidFileSize();
    }

    // Factures prestations (platform et provider)
    match /invoices/{invoiceType}/{year}/{month}/{fileName} {
      // Validate invoiceType to prevent path traversal
      function isValidInvoiceType() {
        return invoiceType in ['platform', 'provider', 'client', 'commission'];
      }
      // Validate year/month format
      function isValidDatePath() {
        return year.matches('^[0-9]{4}$') && month.matches('^(0[1-9]|1[0-2])$');
      }
      // Lecture: utilisateurs authentifiés (les URLs sont signées)
      allow read: if isAuthenticated() && isValidInvoiceType() && isValidDatePath();
      // Écriture: utilisateurs authentifiés peuvent créer des factures PDF
      allow create: if isAuthenticated() &&
                    isValidInvoiceType() &&
                    isValidDatePath() &&
                    request.resource.contentType == 'application/pdf' &&
                    request.resource.size < 5 * 1024 * 1024;
      // Suppression: admins uniquement
      allow delete: if isAdmin() && isValidInvoiceType();
    }

    match /backups/{fileName} {
      allow read, write: if isAdmin();
    }

    // Dispute evidence uploads - P0 FIX
    match /disputes/{disputeId}/evidence/{fileName} {
      // Read: Admin or parties involved in the dispute
      allow read: if isAuthenticated() && isAdmin();
      // Write: Authenticated users can upload evidence (admin validates disputeId)
      allow write: if isAuthenticated() &&
                   isImage() &&
                   isValidFileSize();
      // Delete: Admin only
      allow delete: if isAdmin();
    }

    // FEEDBACK SCREENSHOTS: User feedback attachments
    // Security: Anonymous uploads allowed (visitors can report issues)
    // - Images only (jpeg, png, webp, gif)
    // - Max 5MB
    // Read: Admin only (for reviewing feedback)
    match /feedback_screenshots/{fileName} {
      allow read: if isAdmin();
      // Allow anonymous uploads with strict validation
      allow write: if isImage() &&
                   request.resource != null &&
                   request.resource.size < 5 * 1024 * 1024;
      allow delete: if isAdmin();
    }

    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
